<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Поле для ввода карты</title>
    <style>
        :root{--bg:#f5f7fb;--card:#fff;--accent:#2b7cff;--muted:#7b8898}
        html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#eef3fb,#fdfcff)}
        .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
        .card{background:var(--card);border-radius:12px;padding:28px 22px;width:360px;box-shadow:0 6px 18px rgba(19,30,59,0.08);text-align:left}
        h1{font-size:16px;margin:0 0 12px;color:#0f1724}
        .field{position:relative}
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
        input[type="text"]{
            width:100%;
            padding:14px 44px 14px 14px;
            font-size:16px;
            border:1px solid #e6eaf0;
            border-radius:8px;
            background:linear-gradient(180deg,#fff,#fbfdff);
            outline:none;
            box-sizing:border-box;
            transition:box-shadow .12s, border-color .12s;
        }
        input[type="text"]:focus{box-shadow:0 6px 18px rgba(43,124,255,0.12);border-color:var(--accent)}
        .icon{position:absolute;right:12px;top:42px;transform:translateY(-50%);width:28px;height:18px;opacity:.9}
        .msg{margin-top:10px;font-size:13px;color:var(--muted);min-height:18px}
        .msg.error{color:#c64343}
        .msg.ok{color:#1b9e6b}
        .row{display:flex;gap:12px}
        .col{flex:1}
        .small{width:120px}
        .visually-hidden{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;border:0!important}
        .note{margin-top:12px;padding:10px;background:#fff3cd;border:1px solid #ffeeba;border-radius:8px;color:#664d03;font-size:13px}
        .btn{display:inline-block;margin-top:12px;padding:10px 14px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer}
        .result{margin-top:12px;padding:10px;border-radius:8px;background:#f1f4f9;color:#0f1724;font-size:13px}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card" role="region" aria-label="Ввод данных карты">
            <h1>Введите номер карты</h1>
            <div class="field">
                <label for="card">Номер карты</label>
                <input id="card" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456" aria-describedby="card-msg" maxlength="19" />
                <svg class="icon" viewBox="0 0 42 26" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <rect x="0" y="3" width="42" height="20" rx="3" fill="#f1f4f9"/>
                    <rect x="2" y="6" width="38" height="4" rx="1" fill="#dbe7ff"/>
                    <circle cx="12" cy="16" r="3.2" fill="#ffb347"/>
                    <circle cx="20" cy="16" r="3.2" fill="#ff6b6b"/>
                </svg>
                <div id="card-msg" class="msg" aria-live="polite"></div>
            </div>

            <div class="field">
                <div class="row">
                    <div class="col">
                        <label for="expiry">Срок действия (MM/YY)</label>
                        <input id="expiry" class="small" type="text" inputmode="numeric" placeholder="MM/YY" aria-describedby="expiry-msg" maxlength="5" />
                        <div id="expiry-msg" class="msg" aria-live="polite"></div>
                    </div>
                    <div class="col">
                        <label for="cvv">CVV</label>
                        <input id="cvv" class="small" type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="123" aria-describedby="cvv-msg" maxlength="3" />
                        <div id="cvv-msg" class="msg" aria-live="polite"></div>
                    </div>
                </div>
            </div>
            <!-- <div class="note" role="status">Учебная демонстрация: НЕ вводите реальные реквизиты карт. Эта страница показывает валидацию и маскирование локально — данные не отправляются на сервер.</div> -->
            <!-- <button id="submit-btn" class="btn" type="button">Отправить</button> -->
            <button id="send-server-btn" class="btn" type="button" style="background:#475569;margin-left:8px">Отправить на сервер</button>
            <div id="submit-result" class="result" aria-live="polite" style="display:none"></div>
        </div>
    </div>

    <script>
        const cardInput = document.getElementById('card');
        const cardMsg = document.getElementById('card-msg');
        const expiryInput = document.getElementById('expiry');
        const expiryMsg = document.getElementById('expiry-msg');
        const cvvInput = document.getElementById('cvv');
        const cvvMsg = document.getElementById('cvv-msg');

        function formatCard(v){
            return v.replace(/\D/g,'').slice(0,16).replace(/(.{4})/g,'$1 ').trim();
        }

        function luhnCheck(number){
            const digits = number.split('').reverse().map(d=>+d);
            let sum = 0;
            for(let i=0;i<digits.length;i++){
                let val = digits[i];
                if(i % 2 === 1) { val *= 2; if(val>9) val -= 9; }
                sum += val;
            }
            return sum % 10 === 0;
        }

        function formatExpiry(v){
            const digits = v.replace(/\D/g,'').slice(0,4);
            if(digits.length <= 2) return digits;
            return digits.slice(0,2) + '/' + digits.slice(2);
        }

        function isExpiryValid(digits4){
            if(digits4.length !== 4) return null; // not enough to validate yet
            const mm = parseInt(digits4.slice(0,2),10);
            const yy = parseInt(digits4.slice(2,4),10);
            if(Number.isNaN(mm) || Number.isNaN(yy)) return false;
            if(mm < 1 || mm > 12) return false;
            const now = new Date();
            const fullYear = 2000 + yy;
            const month = mm;
            if(fullYear < now.getFullYear()) return false;
            if(fullYear === now.getFullYear() && month < (now.getMonth()+1)) return false;
            return true;
        }

        function sanitizeDigits(v, maxLen){
            return v.replace(/\D/g,'').slice(0,maxLen);
        }

        // Card input
        cardInput.addEventListener('input', (e) => {
            const raw = cardInput.value;
            const formatted = formatCard(raw);
            cardInput.value = formatted;
            cardInput.selectionStart = cardInput.selectionEnd = formatted.length;

            const digits = formatted.replace(/\s/g,'');
            if(digits.length < 12){
                cardMsg.textContent = '';
                cardMsg.className = 'msg';
                return;
            }
            if(luhnCheck(digits)){
                cardMsg.textContent = 'Похоже, номер корректен';
                cardMsg.className = 'msg ok';
            } else {
                cardMsg.textContent = 'Некорректный номер карты';
                cardMsg.className = 'msg error';
            }
        });

        cardInput.addEventListener('keydown', (e) => {
            if(e.ctrlKey || e.metaKey || e.key.length > 1) return;
            if(/\D/.test(e.key)) e.preventDefault();
        });

        // Expiry input
        expiryInput.addEventListener('input', (e) => {
            const formatted = formatExpiry(expiryInput.value);
            expiryInput.value = formatted;
            expiryInput.selectionStart = expiryInput.selectionEnd = formatted.length;

            const digits = formatted.replace(/\D/g,'');
            if(digits.length < 4){
                expiryMsg.textContent = '';
                expiryMsg.className = 'msg';
                return;
            }
            const valid = isExpiryValid(digits);
            if(valid){
                expiryMsg.textContent = 'Дата корректна';
                expiryMsg.className = 'msg ok';
            } else {
                expiryMsg.textContent = 'Некорректная дата';
                expiryMsg.className = 'msg error';
            }
        });

        expiryInput.addEventListener('keydown', (e) => {
            // allow digits, slash, navigation, ctrl/meta
            if(e.ctrlKey || e.metaKey || e.key.length > 1) return;
            if(!/\d|\//.test(e.key)) e.preventDefault();
        });

        // CVV input
        cvvInput.addEventListener('input', (e) => {
            const digits = sanitizeDigits(cvvInput.value, 3);
            cvvInput.value = digits;
            cvvInput.selectionStart = cvvInput.selectionEnd = digits.length;
            if(digits.length < 3){
                cvvMsg.textContent = '';
                cvvMsg.className = 'msg';
                return;
            }
            cvvMsg.textContent = 'OK';
            cvvMsg.className = 'msg ok';
        });

        cvvInput.addEventListener('keydown', (e) => {
            if(e.ctrlKey || e.metaKey || e.key.length > 1) return;
            if(/\D/.test(e.key)) e.preventDefault();
        });

        const submitResult = document.getElementById('submit-result');



        const sendServerBtn = document.getElementById('send-server-btn');
        sendServerBtn.addEventListener('click', async () => {
            // reuse validation from above
            const cardDigits = cardInput.value.replace(/\s/g,'');
            const expiryDigits = expiryInput.value.replace(/\D/g,'');
            const cvvDigits = cvvInput.value.replace(/\D/g,'');

            let ok = true;
            if(cardDigits.length < 12 || !luhnCheck(cardDigits)) ok = false;
            if(!(expiryDigits.length === 4 && isExpiryValid(expiryDigits))) ok = false;
            if(cvvDigits.length !== 3) ok = false;

            if(!ok){
                submitResult.style.display = 'block';
                submitResult.textContent = 'Пожалуйста, исправьте ошибки выше перед отправкой на сервер.';
                return;
            }

            const masked = cardInput.value;
            const payload = {
                masked_card: masked,
                expiry: expiryInput.value,
                cvv_mask: cvvDigits,
                consent: true
            };

            submitResult.style.display = 'block';
            submitResult.textContent = 'Отправка на сервер...';

            try{
                const res = await fetch('http://localhost:8000/submit_card', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                if(res.ok){
                    submitResult.textContent = 'Сервер ответил: ' + (j.message||'OK');
                } else {
                    submitResult.textContent = 'Ошибка сервера: ' + (j.message||res.statusText);
                }
            } catch(err){
                submitResult.textContent = 'Не удалось связаться с сервером: ' + err.message;
            }
        });
    </script>
</body>
</html>